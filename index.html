<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Secure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-section { @apply bg-white p-6 rounded-lg shadow-md mb-6; }
        .form-label { @apply block text-sm font-medium text-gray-700 mb-1; }
        .form-input, .form-textarea, .form-select { @apply w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500; }
        .form-button { @apply w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 disabled:opacity-50 disabled:cursor-wait; }
        h2 { @apply text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 mb-4; }
        .location-status { @apply p-3 rounded-lg font-bold text-center mb-4; }
        .grid { grid-template-columns: 1fr; }
        @media (min-width: 768px) { .grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-2xl mx-auto">
        <div class="bg-white p-6 rounded-lg shadow-xl mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-900">SISTEM ABSENSI WAJIB LOKASI</h1>
            <p class="text-gray-600">GPS & TIME VALIDATION</p>
        </div>

        <form id="reportForm" class="space-y-6">
            
            <!-- VALIDASI LOKASI (GPS) -->
            <div id="locationValidation" class="form-section">
                <h2>VALIDASI LOKASI (GPS) / LOCATION VALIDATION</h2>
                <div id="locationStatus" class="location-status bg-yellow-100 text-yellow-800">
                    Mencari lokasi GPS Anda. Mohon Izinkan akses lokasi.
                </div>
                <div id="locationData" class="text-sm text-gray-600 text-center"></div>
            </div>

            <!-- BAGIAN 1 -->
            <div class="form-section">
                <h2>BAGIAN 1: INFORMASI KARYAWAN / EMPLOYEE INFORMATION</h2>
                <div class="grid gap-4">
                    <div><label for="tanggal" class="form-label">Tanggal / Date</label><input type="date" id="tanggal" class="form-input" required></div>
                    <div><label for="namaKaryawan" class="form-label">Nama Karyawan / Employee Name</label><input type="text" id="namaKaryawan" class="form-input" placeholder="Nama lengkap karyawan" required></div>
                    <div><label for="posisi" class="form-label">Posisi</label><input type="text" id="posisi" class="form-input" placeholder="PHL atau Karyawan" required></div>
                    <div><label for="lokasiKerja" class="form-label">Lokasi Kerja / Korwil</label><input type="text" id="lokasiKerja" class="form-input" placeholder="Contoh: Korwil Batam" required></div>
                </div>
            </div>

            <!-- BAGIAN 2 -->
            <div class="form-section">
                <h2>BAGIAN 2: STATUS KEHADIRAN / ATTENDANCE STATUS</h2>
                <div class="space-y-4">
                    <div>
                        <label for="statusKehadiran" class="form-label">Status Hari Ini / Today's Status</label>
                        <select id="statusKehadiran" class="form-select" required>
                            <option value="">-- Pilih Status --</option>
                            <option value="Hadir (Present)">Hadir (Present)</option>
                            <option value="Sakit (Sick)">Sakit (Sick)</option>
                            <option value="Izin (Permission)">Izin (Permission)</option>
                            <option value="Cuti (Leave)">Cuti (Leave)</option>
                        </select>
                    </div>
                    <div>
                        <label for="keterangan" class="form-label">Catatan / Keterangan</label>
                        <textarea id="keterangan" rows="3" class="form-textarea" placeholder="Contoh: Hadir di lokasi site. / Sakit demam, surat dokter terlampir. / Izin urusan keluarga." required></textarea>
                    </div>
                </div>
            </div>

            <!-- BAGIAN 3 -->
            <div class="form-section">
                <h2>BAGIAN 3: BUKTI PENDUKUNG / SUPPORTING EVIDENCE</h2>
                <div>
                    <label for="photoUpload" class="form-label">Upload Bukti (Selfie Wajib memperlihatkan QR Code Pos)</label>
                    <input type="file" id="photoUpload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/jpeg, image/png" multiple>
                    <p class="text-xs text-gray-500 mt-2">*Foto Wajib Selfie di lokasi. Disarankan diisi jika status BUKAN 'Hadir'.</p>
                </div>
            </div>

            <div class="mt-6">
                <button type="submit" id="submitButton" class="form-button" disabled>
                    Kirim Laporan (Menunggu Lokasi GPS)
                </button>
            </div>
            <div id="status" class="text-center text-green-600 font-medium mt-4"></div>

        </form>
    </div>

    <script>
        // --- KONFIGURASI FINAL ---
        // URL WEB APP ANDA (SUDAH DI-INPUT)
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby0LlidZLkS4OSDrbcSblhcvi8tYEDg0dq6s0F97IXRJtCuidnWtetbJ2eSfjGmZgmK/exec'; 
        
        // KOORDINAT KORWIL ANDA (SUDAH DI-INPUT)
        const ALLOWED_RADIUS_METERS = 100;
        const VALID_LOCATIONS = [
            { name: "Korwil 1 (0.748, 104.201)", lat: 0.748490, lng: 104.201740 },
            { name: "Korwil 2 (0.877, 104.149)", lat: 0.877055, lng: 104.149263 }
        ];
        // -------------------------

        let userLocationData = null;

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c * 1000; 
        }

        function checkPosition(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            
            const statusDiv = document.getElementById('locationStatus');
            const dataDiv = document.getElementById('locationData');
            const submitButton = document.getElementById('submitButton');
            
            let isInsideAllowedZone = false;
            let closestDistance = Infinity;
            let closestLocationName = "";

            VALID_LOCATIONS.forEach(loc => {
                const distance = calculateDistance(userLat, userLng, loc.lat, loc.lng);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestLocationName = loc.name;
                }
                if (distance <= ALLOWED_RADIUS_METERS) {
                    isInsideAllowedZone = true;
                }
            });
            
            dataDiv.innerHTML = `GPS Anda: ${userLat.toFixed(5)}, ${userLng.toFixed(5)}.<br>Jarak ke titik terdekat: ${closestDistance.toFixed(0)} meter (${closestLocationName}).`;

            if (isInsideAllowedZone) {
                submitButton.disabled = false;
                submitButton.textContent = 'KIRIM LAPORAN (LOKASI SAH)';
                submitButton.classList.remove('bg-gray-400');
                submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
                statusDiv.className = 'location-status bg-green-100 text-green-800';
                statusDiv.innerHTML = `LOKASI DITERIMA! Anda berada di ${closestLocationName}.`;
            } else {
                submitButton.disabled = true;
                submitButton.textContent = 'Kirim Laporan (LOKASI DITOLAK)';
                submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-green-600');
                submitButton.classList.add('bg-gray-400');
                statusDiv.className = 'location-status bg-red-100 text-red-800';
                statusDiv.innerHTML = `LOKASI DITOLAK! Anda ${closestDistance.toFixed(0)} meter dari lokasi kerja terdekat.`;
            }
        }
        
        function errorPosition(error) {
            const statusDiv = document.getElementById('locationStatus');
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = 'GPS Error';
            
            let msg = "Error GPS tidak diketahui.";
            if (error.code === 1) msg = "Mohon IZINKAN akses lokasi di browser Anda.";
            if (error.code === 2) msg = "Sinyal GPS tidak ditemukan. Coba di luar ruangan.";
            if (error.code === 3) msg = "Waktu habis saat mencari GPS.";

            statusDiv.className = 'location-status bg-red-100 text-red-800';
            statusDiv.innerHTML = `ERROR: ${msg}`;
        }

        function getLocation() {
            if (!navigator.geolocation) {
                document.getElementById('locationStatus').innerHTML = 'Browser tidak mendukung GPS.';
                return;
            }
            navigator.geolocation.getCurrentPosition(checkPosition, errorPosition, {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            });
        }
        
        document.addEventListener('DOMContentLoaded', getLocation);
        
        const reportForm = document.getElementById('reportForm');
        const statusDiv = document.getElementById('status');
        const tanggalInput = document.getElementById('tanggal');
        const submitButton = document.getElementById('submitButton');
        
        tanggalInput.value = new Date().toISOString().split('T')[0];

        reportForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            if (submitButton.disabled) {
                alert('Lokasi belum valid!');
                return;
            }
            
            statusDiv.textContent = 'Mengirim laporan...';
            statusDiv.className = 'text-center text-yellow-600 font-medium mt-4';
            submitButton.disabled = true;

            try {
                const formData = {
                    tanggal: document.getElementById('tanggal').value,
                    namaKaryawan: document.getElementById('namaKaryawan').value,
                    posisi: document.getElementById('posisi').value,
                    lokasiKerja: document.getElementById('lokasiKerja').value,
                    statusKehadiran: document.getElementById('statusKehadiran').value,
                    keterangan: document.getElementById('keterangan').value,
                    submissionTime: new Date().toISOString()
                };

                const photoFiles = document.getElementById('photoUpload').files;
                const photoDataUrls = await readFilesAsDataUrls(photoFiles);

                const payload = { formData: formData, photoDataUrls: photoDataUrls };

                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    statusDiv.textContent = 'Sukses! Laporan terkirim.';
                    statusDiv.className = 'text-center text-green-600 font-medium mt-4';
                    reportForm.reset();
                    tanggalInput.value = new Date().toISOString().split('T')[0];
                    setTimeout(getLocation, 2000); 
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                console.error(error);
                statusDiv.textContent = 'Gagal: ' + error.message;
                statusDiv.className = 'text-center text-red-600 font-medium mt-4';
            } finally {
                submitButton.disabled = false;
            }
        });

        function readFilesAsDataUrls(files) {
            return Promise.all(Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }));
        }
    </script>
</body>
</html>
