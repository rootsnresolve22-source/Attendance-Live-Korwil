<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Secure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-section { @apply bg-white p-6 rounded-lg shadow-md mb-6; }
        .form-label { @apply block text-sm font-medium text-gray-700 mb-1; }
        .form-input, .form-textarea, .form-select { @apply w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500; }
        .form-button { @apply w-full text-white font-bold py-3 px-4 rounded-lg shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed; }
        h2 { @apply text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 mb-4; }
        .location-status { @apply p-3 rounded-lg font-bold text-center mb-4; }
        .grid { grid-template-columns: 1fr; }
        @media (min-width: 768px) { .grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-2xl mx-auto">
        <div class="bg-white p-6 rounded-lg shadow-xl mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-900">SISTEM ABSENSI</h1>
            <p class="text-gray-600">GPS & TIME VALIDATION SYSTEM</p>
        </div>

        <form id="reportForm" class="space-y-6">
            
            <div id="locationValidation" class="form-section transition-opacity duration-300">
                <h2>VALIDASI LOKASI / LOCATION CHECK</h2>
                <div id="locationStatus" class="location-status bg-yellow-100 text-yellow-800">
                    Menunggu Status Kehadiran...
                </div>
                <div id="locationData" class="text-sm text-gray-600 text-center"></div>
            </div>

            <div class="form-section">
                <h2>BAGIAN 1: INFORMASI KARYAWAN</h2>
                <div class="grid gap-4">
                    <div><label for="tanggal" class="form-label">Tanggal / Date</label><input type="date" id="tanggal" class="form-input" required></div>
                    <div><label for="namaKaryawan" class="form-label">Nama Karyawan / Name</label><input type="text" id="namaKaryawan" class="form-input" placeholder="Nama Lengkap" required></div>
                    <div><label for="posisi" class="form-label">Posisi / Position</label><input type="text" id="posisi" class="form-input" placeholder="Jabatan Anda" required></div>
                    <div><label for="lokasiKerja" class="form-label">Lokasi Kerja / Site</label><input type="text" id="lokasiKerja" class="form-input" placeholder="Contoh: Korwil Batam" required></div>
                </div>
            </div>

            <div class="form-section border-l-4 border-blue-500">
                <h2>BAGIAN 2: STATUS KEHADIRAN</h2>
                <div class="space-y-4">
                    <div>
                        <label for="statusKehadiran" class="form-label text-lg">Status Hari Ini / Today's Status</label>
                        <select id="statusKehadiran" class="form-select bg-gray-50 border-blue-300" required>
                            <option value="">-- Pilih Status (Wajib) --</option>
                            <option value="Hadir (Present)">Hadir (Present)</option>
                            <option value="Sakit (Sick)">Sakit (Sick)</option>
                            <option value="Izin (Permission)">Izin (Permission)</option>
                            <option value="Cuti (Leave)">Cuti (Leave)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">*Pilih "Hadir" untuk validasi GPS. Pilih Sakit/Izin/Cuti untuk bypass GPS.</p>
                    </div>
                    <div>
                        <label for="keterangan" class="form-label">Catatan / Keterangan</label>
                        <textarea id="keterangan" rows="3" class="form-textarea" placeholder="Detail keterangan..." required></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>BAGIAN 3: BUKTI / EVIDENCE</h2>
                <div>
                    <label for="photoUpload" class="form-label">Upload Bukti (Foto/Selfie)</label>
                    <input type="file" id="photoUpload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/jpeg, image/png" multiple>
                </div>
            </div>

            <div class="mt-6">
                <button type="submit" id="submitButton" class="form-button bg-gray-400" disabled>
                    Pilih Status Terlebih Dahulu
                </button>
            </div>
            <div id="status" class="text-center font-medium mt-4"></div>

        </form>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION AREA
        // ============================================================
        
        // 1. URL Web App (SUDAH SAYA INPUT SESUAI REQUEST ANDA)
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby0LlidZLkS4OSDrbcSblhcvi8tYEDg0dq6s0F97IXRJtCuidnWtetbJ2eSfjGmZgmK/exec'; 
        
        // 2. Tentukan Titik Lokasi Kantor (Latitude, Longitude)
        // Edit angka di bawah ini sesuai lokasi asli kantor Anda
        const ALLOWED_RADIUS_METERS = 100;
        const VALID_LOCATIONS = [
            { name: "Korwil 1 (0.748, 104.201)", lat: 0.748490, lng: 104.201740 },
            { name: "Korwil 2 (0.877, 104.149)", lat: 0.877055, lng: 104.149263 }
        ];

        // ============================================================
        // SYSTEM LOGIC (DO NOT EDIT BELOW THIS LINE)
        // ============================================================

        let currentUserLat = null;
        let currentUserLng = null;
        let isInsideZone = false;
        let distanceInfo = "";

        const statusSelect = document.getElementById('statusKehadiran');
        const submitBtn = document.getElementById('submitButton');
        const locStatusDiv = document.getElementById('locationStatus');
        const locDataDiv = document.getElementById('locationData');

        // Rumus Matematika Jarak (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c * 1000; 
        }

        // Logic "Smart Button" (Hadir vs Sakit)
        function updateFormLogic() {
            const selectedStatus = statusSelect.value;
            
            // KONDISI 1: SAKIT / IZIN / CUTI
            // Tombol jadi BIRU, Langsung Aktif, GPS Diabaikan
            if (selectedStatus.includes("Sakit") || selectedStatus.includes("Izin") || selectedStatus.includes("Cuti")) {
                submitBtn.disabled = false;
                submitBtn.textContent = `KIRIM LAPORAN (${selectedStatus.split(' ')[0].toUpperCase()})`;
                submitBtn.className = "form-button bg-blue-600 hover:bg-blue-700 shadow-blue-500/50"; 
                
                locStatusDiv.className = "location-status bg-blue-100 text-blue-800";
                locStatusDiv.innerHTML = "Mode Non-Hadir: Validasi Lokasi Diabaikan (Otomatis Sah).";
                return; 
            }

            // KONDISI 2: HADIR
            // Tombol jadi HIJAU (Hanya jika GPS valid), jika tidak tombol MATI
            if (selectedStatus.includes("Hadir")) {
                if (currentUserLat === null) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = "Mencari GPS...";
                    submitBtn.className = "form-button bg-gray-400 cursor-wait";
                    locStatusDiv.className = "location-status bg-yellow-100 text-yellow-800";
                    locStatusDiv.innerHTML = "Sedang mencari titik lokasi Anda...";
                } else if (isInsideZone) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "KIRIM ABSENSI (LOKASI SAH)";
                    submitBtn.className = "form-button bg-green-600 hover:bg-green-700 shadow-green-500/50"; 
                    locStatusDiv.className = "location-status bg-green-100 text-green-800";
                    locStatusDiv.innerHTML = `LOKASI SAH! (Jarak: ${distanceInfo})`;
                } else {
                    submitBtn.disabled = true;
                    submitBtn.textContent = "LOKASI DITOLAK (DILUAR JANGKAUAN)";
                    submitBtn.className = "form-button bg-red-600 opacity-75 cursor-not-allowed"; 
                    locStatusDiv.className = "location-status bg-red-100 text-red-800";
                    locStatusDiv.innerHTML = `ANDA DILUAR JANGKAUAN! (Jarak: ${distanceInfo})`;
                }
                return;
            }

            // Default
            submitBtn.disabled = true;
            submitBtn.textContent = "Pilih Status Kehadiran Terlebih Dahulu";
            submitBtn.className = "form-button bg-gray-400";
            locStatusDiv.className = "location-status bg-gray-100 text-gray-600";
            locStatusDiv.innerHTML = "Menunggu input status...";
        }

        // Fungsi Cek Posisi GPS
        function checkPosition(position) {
            currentUserLat = position.coords.latitude;
            currentUserLng = position.coords.longitude;
            
            let closestDistance = Infinity;
            let closestName = "";

            VALID_LOCATIONS.forEach(loc => {
                const dist = calculateDistance(currentUserLat, currentUserLng, loc.lat, loc.lng);
                if (dist < closestDistance) {
                    closestDistance = dist;
                    closestName = loc.name;
                }
            });
            
            isInsideZone = (closestDistance <= ALLOWED_RADIUS_METERS);
            distanceInfo = `${closestDistance.toFixed(0)}m dari ${closestName}`;
            
            locDataDiv.innerHTML = `GPS: ${currentUserLat.toFixed(5)}, ${currentUserLng.toFixed(5)}`;
            updateFormLogic();
        }

        function errorPosition(error) {
            locDataDiv.innerHTML = "Gagal mengambil GPS.";
            updateFormLogic(); 
        }

        // Setup Awal
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
            
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(checkPosition, errorPosition, {
                    enableHighAccuracy: true, timeout: 20000, maximumAge: 0
                });
            } else {
                locDataDiv.innerHTML = "Browser tidak support GPS.";
            }
        });

        statusSelect.addEventListener('change', updateFormLogic);

        // Proses Kirim Data
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (submitBtn.disabled) return;
            
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = 'Sedang mengirim data...';
            statusDiv.className = 'text-center text-blue-600 font-bold mt-4';
            submitBtn.disabled = true; 
            submitBtn.textContent = "MENGIRIM...";

            try {
                const formData = {
                    tanggal: document.getElementById('tanggal').value,
                    namaKaryawan: document.getElementById('namaKaryawan').value,
                    posisi: document.getElementById('posisi').value,
                    lokasiKerja: document.getElementById('lokasiKerja').value,
                    statusKehadiran: statusSelect.value,
                    keterangan: document.getElementById('keterangan').value,
                    submissionTime: new Date().toISOString()
                };

                const photoFiles = document.getElementById('photoUpload').files;
                const photoDataUrls = await readFilesAsDataUrls(photoFiles);

                // Kirim ke Google Script
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ formData, photoDataUrls }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    statusDiv.innerHTML = '✅ Laporan Berhasil Terkirim!';
                    statusDiv.className = 'text-center text-green-600 font-bold mt-4';
                    document.getElementById('reportForm').reset();
                    setTimeout(() => location.reload(), 3000); 
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                statusDiv.innerHTML = '❌ Gagal: ' + error.message;
                statusDiv.className = 'text-center text-red-600 font-bold mt-4';
                submitBtn.disabled = false;
                updateFormLogic(); 
            }
        });

        function readFilesAsDataUrls(files) {
            return Promise.all(Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }));
        }
    </script>
</body>
</html>
